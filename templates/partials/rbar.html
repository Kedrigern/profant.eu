<div class="card mb-4 shadow-sm border-0">
    <div class="card-header bg-dark text-white">
        O mně
    </div>
    <div class="card-body">
        <p class="card-text small">
            IT specialista se zkušenostmi poslance, náměstka ministr pro digitalizaci a Pirát. Bojuji za digitalizaci, svobodu internetu a otevřená data.
        </p>
        <a href="{{ get_url(path="bio") }}" class="btn btn-sm btn-outline-dark w-100">Více o mně</a>
    </div>
</div>

<div class="card mb-4 shadow-sm border-0">
    <div class="card-body">
        <h5 class="card-title h6 mb-3">Kde mě najdete</h5>
        <div class="d-grid gap-2">
            <a href="{{ config.extra.mastodon_url }}" class="btn btn-outline-primary btn-sm text-start" rel="me">
                <i class="fa-brands fa-mastodon me-2"></i> Mastodon
            </a>
            <a href="{{ config.extra.bluesky_url }}" class="btn btn-outline-info btn-sm text-start" rel="me">
                <i class="fa-brands fa-bluesky me-2"></i> Bluesky
            </a>
        </div>
    </div>
</div>

<div class="card mb-4 shadow-sm border-0">
    <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
        <span>Aktuálně</span>
        <i class="fa-brands fa-mastodon text-primary"></i>
    </div>

    <div class="list-group list-group-flush" id="mastodon-feed">
        <div class="p-3 text-center text-muted small">
            <i class="fa-solid fa-spinner fa-spin"></i> Načítám...
        </div>
    </div>

    <div class="card-footer bg-white border-top-0">
        <a href="{{ config.extra.mastodon_url }}" class="btn btn-sm btn-light w-100 text-muted">Zobrazit více</a>
    </div>
</div>

<div class="card mb-4 shadow-sm border-0">
    <div class="card-header bg-white fw-bold">
        Vybrané články
    </div>
    <div class="list-group list-group-flush">
        <a href="{{ get_url(path="2022-07-07-bankovni-identity") }}" class="list-group-item list-group-item-action small border-0">
            <i class="fa-solid fa-chevron-right me-2 text-primary small"></i>
            Bankovní identita není všespásná
        </a>
        <a href="{{ get_url(path="2019-11-26-zpds") }}" class="list-group-item list-group-item-action small border-0">
            <i class="fa-solid fa-chevron-right me-2 text-primary small"></i>
            Zákon o právu na digitální služby
        </a>
    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const INSTANCE = "https://mastodon.pirati.cz";
    const USERNAME = "keddie";
    const LIMIT = 5;

    const feedContainer = document.getElementById('mastodon-feed');

    fetch(`${INSTANCE}/api/v1/accounts/lookup?acct=${USERNAME}`)
        .then(response => {
            if (!response.ok) throw new Error("Účet nenalezen");
            return response.json();
        })
        .then(account => {
            // Stahujeme statusy
            return fetch(`${INSTANCE}/api/v1/accounts/${account.id}/statuses?limit=${LIMIT}&exclude_replies=true`);
        })
        .then(response => response.json())
        .then(data => {
            if (!Array.isArray(data)) throw new Error("API nevrátilo seznam");

            feedContainer.innerHTML = "";

            // Zobrazíme max 3 příspěvky
            data.slice(0, 3).forEach(toot => {
                const isReblog = !!toot.reblog;
                const post = isReblog ? toot.reblog : toot;

                // Formátování data
                const date = new Date(toot.created_at).toLocaleDateString('cs-CZ', {
                    day: 'numeric', month: 'numeric', year: 'numeric'
                });

                // --- 1. NÁHLEDOVÁ KARTA (Link Preview) ---
                let cardHtml = "";
                if (post.card && post.card.url) {
                    // Pokud má post náhled odkazu (Card)
                    const cardImg = post.card.image
                        ? `<div class="card-img-top" style="background-image: url('${post.card.image}'); height: 120px; background-size: cover; background-position: center;"></div>`
                        : '';

                    cardHtml = `
                        <a href="${post.card.url}" target="_blank" rel="noopener" class="mastodon-card d-block mt-2 border rounded text-decoration-none text-dark overflow-hidden">
                            ${cardImg}
                            <div class="p-2 bg-light">
                                <div class="small fw-bold text-truncate">${post.card.title}</div>
                                <div class="small text-muted text-truncate" style="font-size: 0.8em;">${post.card.provider_name || 'Odkaz'}</div>
                            </div>
                        </a>
                    `;
                }
                // Pokud nemá kartu, ale má aspoň obrázky (Media Attachments)
                else if (post.media_attachments && post.media_attachments.length > 0) {
                     cardHtml = `<div class="mt-2"><i class="fa-regular fa-image text-muted me-1"></i><small class="text-muted">Příloha (${post.media_attachments.length})</small></div>`;
                }

                // Header pro reblog
                const reblogBadge = isReblog
                    ? '<div class="text-success small mb-1"><i class="fa-solid fa-retweet me-1"></i> Sdíleno</div>'
                    : '';

                // Vytvoření elementu
                const item = document.createElement('div');
                item.className = "list-group-item border-0 p-3 border-bottom";

                // Sestavení HTML
                item.innerHTML = `
                    ${reblogBadge}
                    <div class="mastodon-content text-dark small">
                        ${post.content}
                    </div>
                    ${cardHtml}
                    <div class="d-flex justify-content-end mt-2">
                        <a href="${toot.url}" target="_blank" rel="noopener" class="text-muted small text-decoration-none">
                            <i class="fa-regular fa-clock me-1"></i> ${date}
                        </a>
                    </div>
                `;
                feedContainer.appendChild(item);
            });
        })
        .catch(error => {
            console.error(error);
            feedContainer.innerHTML = '<div class="p-3 text-center text-muted small">Nelze načíst feed.</div>';
        });
});
</script>

<style>
/* CSS pro úpravu vzhledu Mastodon obsahu */
.mastodon-content p {
    margin-bottom: 0.5rem;
}
.mastodon-content p:last-child {
    margin-bottom: 0;
}

/* Odkazy uvnitř textu příspěvku */
.mastodon-content a {
    color: #0d6efd !important; /* Vynutíme modrou barvu */
    text-decoration: none;
    word-break: break-word;
}
.mastodon-content a:hover {
    text-decoration: underline;
}

/* Náhledová karta */
.mastodon-card:hover {
    background-color: #f8f9fa;
    opacity: 0.9;
}

/* Skrytí technických elementů, které Mastodon API posílá pro čtečky */
.mastodon-content .invisible {
    display: none;
}
.mastodon-content .ellipsis {
    /* Ellipsis necháme, je to ta část "..." v dlouhém odkazu */
}
</style>
